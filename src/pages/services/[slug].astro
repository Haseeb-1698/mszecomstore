---
import Layout from '../../layouts/Layout.astro';
import { getServices } from '../../lib/api/services';
import ServiceDetail from '../../components/service/ServiceDetail';

// Fetch all services once and pass data to each page via props
// This eliminates the N+1 database call problem
export async function getStaticPaths() {
  const services = await getServices();
  return services.map(service => ({
    params: { slug: service.slug || service.name.toLowerCase().replace(/ /g, '-') },
    props: { service }, // Pass the full service data to avoid refetching
  }));
}

// Get service from props (already fetched in getStaticPaths)
const { service } = Astro.props;

// Since getStaticPaths only generates paths for existing services, service should always exist
// But we'll handle the case gracefully
if (!service) {
  return Astro.redirect('/404');
}

// Transform plans for the component
const plans = (service.plans || []).map(plan => ({
  id: plan.id,
  name: plan.name,
  duration_months: plan.duration_months,
  price: plan.price,
  features: Array.isArray(plan.features) ? plan.features.filter((f): f is string => typeof f === 'string') : [],
  is_popular: plan.is_popular,
  is_available: plan.is_available,
}));
---

<Layout title={`${service.name} - MSZ Ecom Store`}>
  <ServiceDetail
    client:load
    serviceId={service.id}
    serviceName={service.name}
    serviceDescription={service.description || ''}
    serviceLongDescription={service.long_description ?? undefined}
    serviceIcon={service.icon_url ?? undefined}
    plans={plans}
  />
</Layout>
